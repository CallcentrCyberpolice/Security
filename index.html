<!DOCTYPE html>
<html>
<head>
    <title>Coin Game</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        h2 { color: #333; }
        p { margin-bottom: 10px; }
          ul {
            list-style-type: none;
            padding: 0;
          }
          li {
            margin-bottom: 5px;
          }
    </style>
</head>
<body>
    <div class="container">
        <h2>Інформація про користувача</h2>
        <div id="user-data">
            <p><strong>Telegram ID:</strong> <span id="user-id"></span></p>
            <p><strong>Ім'я:</strong> <span id="first-name"></span></p>
            <p><strong>Нікнейм:</strong> <span id="username"></span></p>
            <p><strong>Реферальне посилання:</strong> <span id="referral-link"></span></p>
            <p><strong>Вас запросив:</strong> <span id="referrer-id"></span></p>
            <p><strong>Запрошені користувачі:</strong>
             <ul id="referrals-list"></ul>
                </p>
           <p><strong>Ваші монети:</strong> <span id="coins"></span></p>
        </div>
    </div>
      <script>
         function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

          const userId = getParameterByName('user_id');
           function fetchData(){
                const xhr = new XMLHttpRequest();
                     xhr.open("GET", `/my_data?user_id=${userId}`, true);
                    xhr.onload = function () {
                        if (xhr.status === 200) {
                             const data = JSON.parse(xhr.responseText);
                            document.getElementById('user-id').textContent = userId;
                           document.getElementById('first-name').textContent = data.first_name;
                            document.getElementById('username').textContent = data.username || "Немає";
                            document.getElementById('referral-link').textContent =`t.me/YOUR_BOT_USERNAME?start=${userId}`;
                            document.getElementById('referrer-id').textContent = data.referrer || "Немає";
                            document.getElementById('coins').textContent = data.coins;


                            const referralsList = document.getElementById('referrals-list');
                            referralsList.innerHTML = "";
                            if(data.referrals){
                              data.referrals.forEach(refId => {
                             const refData = getReferralData(refId);
                            if(refData){
                                const li = document.createElement('li');
                                   li.textContent = `ID: ${refId}, Name: ${refData.first_name || 'Немає'}  Username: ${refData.username || "Немає"}`;
                                 referralsList.appendChild(li);
                            }
                            });
                            }else{
                                const li = document.createElement('li');
                                 li.textContent = `Немає запрошених користувачів`;
                                 referralsList.appendChild(li);
                            }


                        } else {
                         console.error("Помилка під час запиту даних:", xhr.status);
                             document.getElementById('user-data').innerHTML = "<p>Помилка: Неможливо отримати дані про користувача</p>";
                        }
                    };
                 xhr.send();
             }

            function getReferralData(refId){
                    let refData = null;
                   const xhr = new XMLHttpRequest();
                         xhr.open("GET", `/my_data?user_id=${refId}`, false);
                         xhr.onload = function () {
                            if (xhr.status === 200) {
                                refData =  JSON.parse(xhr.responseText);
                            } else {
                              console.error("Помилка під час запиту даних:", xhr.status);
                            }
                        }
                         xhr.send();
                        return refData;
               }


        if (userId) {
             fetch(`https://api.telegram.org/bot${TOKEN}/getUpdates?offset=-1`) // Замініть на токен вашого бота
                .then(response => response.json())
                .then(data => {
                  const updates = data.result;
                    if (updates && updates.length > 0) {
                    const lastUpdate = updates[updates.length -1];
                    const lastMessage = lastUpdate.message;
                    if (lastMessage && lastMessage.from.id === parseInt(userId)) {

                         fetchData();

                    }else{
                        console.error("Помилка: Немає повідомлень від цього користувача.");
                        document.getElementById('user-data').innerHTML = "<p>Помилка: Немає даних для цього користувача.</p>";
                    }
                   }else{
                        console.error("Помилка: Немає оновлень в телеграм.");
                           document.getElementById('user-data').innerHTML = "<p>Помилка: Неможливо отримати дані з телеграм.</p>";

                     }
                  })
                .catch(error => {
                        console.error("Помилка отримання оновлень:", error);
                        document.getElementById('user-data').innerHTML = "<p>Помилка отримання даних з телеграм.</p>";
                     });

        }
         else {
            document.getElementById('user-data').innerHTML = "<p>Помилка: Немає ID користувача.</p>";
        }
      </script>
</body>
</html>
